<div class="h-full flex flex-col animate-fade-in">
    <div class="flex-shrink-0">
      <h1 class="text-3xl font-bold text-gray-900">النواة المعرفية والتحليل الذكي</h1>
      <p class="text-gray-500 mb-6">هذا هو مركز القيادة للتحليل الاستخباراتي. استخدم المساعد الذكي، قم بتحليل الوسائط المتعددة، ولخص النصوص الطويلة بسرعة فائقة لتعزيز قدراتك الاستقصائية.</p>
    </div>

    <!-- Tabs -->
    <div class="border-b border-gray-200">
      <nav class="-mb-px flex space-i-6" aria-label="Tabs">
        @if (isChatbotEnabled()) {
          <button (click)="setTab('assistant')" [class]="activeTab() === 'assistant' ? 'border-ph-blue text-ph-blue' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
            المساعد الذكي
          </button>
        }
        @if (isImageAnalysisEnabled()) {
          <button (click)="setTab('imageAnalysis')" [class]="activeTab() === 'imageAnalysis' ? 'border-ph-blue text-ph-blue' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
            تحليل الصور
          </button>
        }
        <button (click)="setTab('transcription')" [class]="activeTab() === 'transcription' ? 'border-ph-blue text-ph-blue' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
          التفريغ الصوتي
        </button>
        @if (isQuickSummaryEnabled()) {
          <button (click)="setTab('quickSummary')" [class]="activeTab() === 'quickSummary' ? 'border-ph-blue text-ph-blue' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
            تلخيص سريع
          </button>
        }
      </nav>
    </div>
    
    <!-- Tab Content -->
    <div class="flex-grow pt-6 h-full overflow-y-auto">
        @switch (activeTab()) {
            @case ('assistant') {
              <div class="lg:col-span-2 bg-base-100 p-6 rounded-xl shadow h-full flex flex-col">
                <div class="flex justify-between items-center mb-4 border-b-2 border-ph-yellow pb-2">
                   <h2 class="text-2xl font-bold">YemenGPT AI Assistant</h2>
                   <div class="text-xs font-mono px-2 py-1 rounded-md" [ngClass]="currentAiProvider() === 'google' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'">
                    Powered by: {{ currentAiProvider() === 'google' ? 'Google Gemini' : 'Local AI' }}
                   </div>
                </div>

                <div class="flex-grow overflow-y-auto pr-4 space-y-4">
                    @for(message of messages(); track message.id) {
                      <div class="group flex items-end gap-2" [class.justify-end]="message.from === 'user'" [class.flex-row-reverse]="message.from === 'user'">
                          <div 
                            class="p-4 rounded-lg max-w-lg"
                            [class]="message.from === 'user' ? 'bg-ph-blue text-white rounded-t-xl rounded-s-xl' : 'bg-base-300 rounded-t-xl rounded-e-xl'">
                              <p>{{ message.text }}</p>
                              @if(message.translatedText) {
                                <div class="border-t border-gray-400/50 mt-2 pt-2 text-sm opacity-80" [class.text-gray-200/80]="message.from === 'user'" [class.text-gray-700/80]="message.from === 'ai'">
                                  <p>{{ message.translatedText }}</p>
                                </div>
                              }
                          </div>
                          @if (currentAiProvider() === 'google' && !message.translatedText) {
                            <button (click)="translateMessage(message.id)" [disabled]="message.isTranslating" class="opacity-0 group-hover:opacity-100 transition-opacity p-1 text-gray-400 hover:text-ph-blue">
                                @if (message.isTranslating) {
                                    <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                } @else {
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 21l5.25-11.25L21 21m-9-3h7.5M3 5.621a48.474 48.474 0 0 1 6-.371m0 0c1.12 0 2.233.038 3.334.114M9 5.25V3m3.334 2.364C13.18 7.061 14.287 7.5 15.5 7.5c1.213 0 2.32-.439 3.166-1.136m0 0 is greater than 3.032 3.032 0 0 1-3.675 3.675-3.032 3.032 0 0 1-3.675-3.675M12 12.75h.008v.008H12v-.008Z" /></svg>
                                }
                            </button>
                          }
                      </div>
                    }
                    @if(isTyping()) {
                      <div class="flex">
                        <div class="p-4 rounded-t-xl rounded-e-xl bg-base-300">
                          <div class="flex items-center space-i-2">
                            <span class="w-2 h-2 bg-gray-500 rounded-full animate-pulse"></span>
                            <span class="w-2 h-2 bg-gray-500 rounded-full animate-pulse [animation-delay:0.2s]"></span>
                            <span class="w-2 h-2 bg-gray-500 rounded-full animate-pulse [animation-delay:0.4s]"></span>
                          </div>
                        </div>
                      </div>
                    }
                </div>
                <form (submit)="handleSend($event)" class="mt-4 flex flex-col">
                    <div class="flex items-center">
                        <input #messageInput type="text" placeholder="اسأل YemenGPT..." class="flex-grow p-3 rounded-s-lg border border-gray-300 bg-gray-50 focus:ring-ph-blue focus:border-ph-blue">
                        <button type="submit" class="p-3 bg-ph-blue text-white rounded-e-lg hover:bg-ph-blue-dark">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" />
                        </svg>
                        </button>
                    </div>
                     @if (chatError()) {
                        <p class="text-red-500 text-sm mt-2 text-center">{{ chatError() }}</p>
                    }
                </form>
              </div>
            }
            @case ('imageAnalysis') {
              <app-image-analysis></app-image-analysis>
            }
             @case ('quickSummary') {
              <div class="h-full flex flex-col space-y-4">
                <textarea [(ngModel)]="summaryInputText" class="w-full flex-grow p-3 rounded-lg border border-gray-300 bg-gray-50 resize-none" placeholder="ألصق النص المراد تلخيصه هنا..."></textarea>
                <button (click)="getQuickSummary()" [disabled]="isSummarizing() || !summaryInputText()" class="w-full bg-ph-blue text-white font-bold py-3 px-4 rounded-lg hover:bg-ph-blue-dark disabled:bg-gray-400 flex items-center justify-center">
                   @if(isSummarizing()) {
                      <span>جارِ التلخيص...</span>
                   } @else {
                      <span>لخص النص</span>
                   }
                </button>
                <div class="w-full flex-grow p-3 rounded-lg border border-gray-200 bg-base-200">
                  <p>{{ summaryResult() || 'ستظهر نتيجة التلخيص هنا.' }}</p>
                </div>
              </div>
            }
            @case ('transcription') {
              <div class="bg-base-100 p-6 rounded-xl shadow flex flex-col h-full">
                <h2 class="text-2xl font-bold mb-4 border-b-2 border-ph-yellow pb-2">التفريغ الصوتي الذكي</h2>
                <p class="text-gray-600 mb-4">
                  تحويل صوتي فائق الدقة، مُحسَّن خصيصًا لفهم وتفريغ مختلف اللهجات العربية اليمنية.
                </p>
                <div class="space-y-4 flex-grow flex flex-col">
                  <!-- Form inputs -->
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label for="dialect" class="block mb-2 text-sm font-medium">1. اختر اللهجة:</label>
                      <select id="dialect" [(ngModel)]="selectedDialect" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5">
                        @for(dialect of dialects; track dialect) { <option [value]="dialect">{{dialect}}</option> }
                      </select>
                    </div>
                    <div>
                      <label for="format" class="block mb-2 text-sm font-medium">2. صيغة المخرج:</label>
                      <select id="format" [(ngModel)]="transcriptionFormat" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5">
                        @for(format of outputFormats; track format) { <option [value]="format">{{format}}</option> }
                      </select>
                    </div>
                  </div>
                  <!-- File/URL Input -->
                  <div>
                    <label class="block mb-2 text-sm font-medium">3. اختر المصدر:</label>
                    @if (showYoutubeInput()) {
                      <div class="flex">
                          <input [(ngModel)]="youtubeUrl" type="url" placeholder="https://youtube.com/watch?v=..." class="flex-grow p-2.5 rounded-s-lg border border-gray-300 bg-gray-50 text-sm">
                          <button (click)="toggleYoutubeInput()" class="p-2.5 text-sm font-medium text-gray-600 bg-gray-100 border border-s-0 border-gray-300 rounded-e-lg hover:bg-gray-200">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3" /></svg>
                          </button>
                      </div>
                    } @else {
                      <label for="dropzone-file" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                          <div class="flex flex-col items-center justify-center pt-5 pb-6 text-center">
                              @if (selectedFile()) {
                                <p class="text-sm text-green-600 font-semibold px-1 truncate">{{ selectedFile()?.name }}</p>
                              } @else {
                                <svg class="w-8 h-8 mb-2 text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/></svg>
                                <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">رفع ملف صوتي</span></p>
                                <p class="text-xs text-gray-500">أو <button (click)="toggleYoutubeInput(); $event.preventDefault()" class="text-ph-blue hover:underline font-semibold">استيراد من يوتيوب</button></p>
                              }
                          </div>
                          <input id="dropzone-file" type="file" class="hidden" (change)="handleFileSelect($event)" accept="audio/*" />
                      </label>
                    }
                  </div>
                  <!-- Transcribe Button -->
                  <button (click)="startTranscription()" [disabled]="(!selectedFile() && !youtubeUrl()) || isTranscribing()" class="w-full bg-ph-blue text-white font-bold py-2 px-4 rounded-lg hover:bg-ph-blue-dark disabled:bg-gray-400 flex items-center justify-center">
                    @if(isTranscribing()){ <span>جارِ التفريغ...</span> } @else { <span>بدء التفريغ الصوتي</span> }
                  </button>
                  <!-- Results Textarea -->
                  <div class="mt-auto flex-grow flex flex-col">
                    <label class="block mb-2 text-sm font-medium">4. نتيجة التفريغ:</label>
                    <div class="relative flex-grow">
                      <textarea readonly [value]="transcriptionResult()" class="w-full h-full p-2.5 bg-gray-50 border border-gray-300 text-sm rounded-lg resize-none" placeholder="...ستظهر نتيجة التفريغ هنا"></textarea>
                      @if (transcriptionResult()) {
                        <button (click)="copyResult()" title="Copy to clipboard" class="absolute top-2 end-2 p-1.5 text-gray-500 hover:bg-gray-200 rounded-lg">
                           @if (copySuccess()) { <span class="text-green-500 text-xs">تم النسخ!</span> } @else { <span>نسخ</span> }
                        </button>
                      }
                    </div>
                  </div>
                </div>
              </div>
            }
        }
    </div>
</div>